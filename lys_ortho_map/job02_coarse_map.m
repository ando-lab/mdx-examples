%% Job 2: generate coarse maps

useParallel = true; % run in parallel (requires more RAM and parallel computing toolbox)

%%
% Filter, Integrate, and Correct

workingDir = fullfile('proc',{'2_38','2_39','2_40','2_41','5_51','5_52','5_53','5_54'});
%%
opts = struct(...
    'workingDirectory',workingDir,...
    'ndiv',[5,3,3],...  % this choice impacts speed to a large extent
    'window',2,...
    'maxCount',20,...
    'smax',Inf,...
    'binMode','coarse',...
    'minimumCounts',10,...
    'minimumPixels',10,...
    'parallel',useParallel,...
    'binExcludedVoxels',true...  % treats excluded voxels as Bragg peaks
    );

% assign run options
for j=1:length(opts)
    opts(j).run = {'filter','integrate','correct','export'};
end

[tf,EM] = proc.Batch.autorun(opts);

%% combine wedges

exportIn = fullfile({'2_38','2_39','2_40','2_41','5_51','5_52','5_53','5_54'},'export.mat');

[tf,EM] = proc.Batch.combine(...
    'workingDirectory','proc',...
    'exportIn',exportIn,...
    'combineBragg',true,...
    'mergeNeighbors',true);
